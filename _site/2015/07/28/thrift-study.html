
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>sample</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/"></a>
          <ul class="nav">
            
            
            


  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>sample <small>Supporting tagline</small></h1>
</div>

<div class="row">
  <div class="span10">
    
<h1 id="thrift-">Thrift 探讨</h1>

<h2 id="thrift">Thrift简介</h2>
<p>Apache Thrift提供了一种可扩展，跨语言的服务部署方式。<br />
并且提供了从thrift文件到目标语言的代码生成引擎。 能够很方便的搭建rpc服务端和客户端。</p>

<h2 id="section">使用场景</h2>
<ul>
  <li>构建高效，可水平扩展的服务。  </li>
  <li>复杂系统拆分，系统之间的解耦。  </li>
  <li>Thrift VS REST<br />
    <ul>
      <li>Thrift效率更高。（http://stackoverflow.com/questions/16732082/hbase-thrift-vs-rest-performance）  </li>
      <li>Thrift构建服务更容易，水平扩展也更容易。  </li>
      <li>rest 服务添加接口更容易。  </li>
      <li>rest 服务对于访问的认证，授权等机制更完善。  </li>
      <li>结论：在公司内部服务间的调用使用thrift，提供给外部的服务使用rest.  </li>
    </ul>
  </li>
</ul>

<h2 id="thriftubuntu">thrift命令Ubuntu安装</h2>
<ol>
  <li>安装依赖包： sudo apt-get install libboost-dev libboost-test-dev libboost-program-options-dev libboost-system-dev libboost-filesystem-dev libevent-dev automake libtool flex bison pkg-config g++ libssl-dev  </li>
  <li>下载thrift，./configure; make install  </li>
</ol>

<h2 id="thrift--1">在.thrift 文件中定义类型和服务：</h2>

<h3 id="section-1">类型系统：</h3>
<ul>
  <li>
    <p><strong>基本类型</strong><br />
<em>bool</em>: A boolean value (true or false)<br />
<em>byte</em>: An 8-bit signed integer<br />
<em>i16</em>: A 16-bit signed integer<br />
<em>i32</em>: A 32-bit signed integer<br />
<em>i64</em>: A 64-bit signed integer<br />
<em>double</em>: A 64-bit floating point number<br />
<em>string</em>: A text string encoded using UTF-8 encoding  </p>
  </li>
  <li>
    <p><strong>特殊类型</strong><br />
<em>binary</em>: a sequence of unencoded bytes  </p>
  </li>
  <li>
    <p><strong>集合类型</strong><br />
<em>list</em>: An ordered list of elements<br />
<em>set</em>: An unordered set of unique elements.<br />
<em>map</em>: A map of strictly unique keys to values.<br />
集合支持泛型。list<e>, set<e>, map&lt;K, V&gt;  </e></e></p>
  </li>
</ul>

<h3 id="section-2">定义类型：</h3>

<ul>
  <li>
    <p>枚举类型:  </p>

    <pre><code>  enum ErrorCode {  
      OK = 0,  
      THROW_EXCEPTION = 2,  
      UNKNOWN_ERROR = 3  
  }  
</code></pre>
  </li>
  <li>
    <p>结构体：</p>

    <pre><code>  struct S {  
      1: required i64 id,  
      2: required string name,  
      3: optional string desc,  
  }
</code></pre>
  </li>
  <li>
    <p>Exception:</p>

    <pre><code>  exception Ex {  
      1: required errCode = ErrorCode.OK,  
      2: required string msg="",  
  }
</code></pre>
  </li>
</ul>

<h3 id="section-3">定义服务</h3>

<pre><code>service ServiceA {  
    void ping(),  
    string getStatus()  
}

service ServiceB extends ServiceA {  
    ResponseType doBusiness(1:RequestType req) throws (1: Ex ex)  
}
</code></pre>

<h2 id="thrift-1">Thrift协议</h2>
<pre><code>protocol和transport层采用运行时加载的库，可以不需要重新编译程序就更换这两层的实现。
http://thrift-tutorial.readthedocs.org/en/latest/thrift-stack.html
</code></pre>

<blockquote>
  <blockquote>
    <p><img src="/image/Apache_Thrift_architecture.png" alt="thrift protocol stack" title="Thrift Architecture" /></p>
  </blockquote>
</blockquote>

<h2 id="section-4">跨语言特性</h2>

<ul>
  <li>data format: Bson  </li>
  <li>自动生成服务端和客户端代码。  </li>
</ul>

<h2 id="thrift-2">搭建Thrift服务端和客户端：</h2>

<h3 id="java">Java为例：</h3>

<ol>
  <li>define .thrift file.  </li>
  <li>generate code.  </li>
  <li>service implementation.  </li>
  <li>start service.  </li>
  <li>invoke service.<br />
 https://github.com/kongliangzhong/all-samples/tree/master/thrift-sample-java</li>
</ol>

<h2 id="section-5">客户端多线程调用</h2>
<p>thrift生成的Client不是线程安全的，因此要在客户端实现线程安全，需要对每个线程使用单独的Client。<br />
参见：http://192.168.88.111:9000/upsmart/upsmart-thrift-client</p>

<h2 id="protobuf-avro">类似技术：Protobuf, Avro</h2>
<ul>
  <li>Protobuf: https://developers.google.com/protocol-buffers/  </li>
  <li>Avro: https://avro.apache.org/</li>
</ul>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2015/07/27/rabbitmq-manage.html" title="sample">&larr; Previous</a></li>
      
        <li><a href="">Archive</a></li>
      
        <li class="next"><a href="/2015/08/03/tomcat-jetty-note.html" title="sample">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>28 July 2015</span></div>

    
  </div>
</div>


      </div>

      <footer>
        <p>&copy;  2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    



  </body>
</html>

